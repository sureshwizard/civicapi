<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CivicAPI – Bills Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; margin: 20px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; }
    input, button, select { padding:8px; font-size:14px; }
    .card { border:1px solid #ddd; border-radius:10px; padding:16px; margin:10px 0; }
    .ok { color: #126c27; }
    .err { color: #b00020; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    th { background: #f5f5f5; text-align: left; }
    .right { text-align: right; }
    .muted { color: #666; font-size: 12px; }
  </style>
</head>
<body>
  <h1>CivicAPI — Bills</h1>

  <div class="card">
    <h3>Connection</h3>
    <div class="row">
      <label>Base URL
        <input id="baseUrl" size="40" value="" placeholder="e.g. http://162.0.225.90:4051">
      </label>
      <label>API Key (x-api-key)
        <input id="apiKey" size="36" placeholder="enter your API key">
      </label>
      <button id="saveConn">Save</button>
      <span class="muted">Saved to localStorage</span>
    </div>
    <div id="connMsg" class="muted"></div>
  </div>

  <div class="card">
    <h3>Health Check</h3>
    <button id="btnHealth">Ping /</button>
    <pre id="healthOut" class="muted"></pre>
  </div>

  <div class="card">
    <h3>Upload Bill</h3>
    <div class="row">
      <label>Bill file (txt/pdf)
        <input type="file" id="billFile" accept=".txt,.pdf">
      </label>
      <button id="btnUploadFile">Upload File</button>
    </div>
    <div class="muted">— or manual —</div>
    <div class="row">
      <label>Vendor <input id="vendor"></label>
      <label>Amount <input id="amount" type="number" step="0.01"></label>
      <label>Due Date <input id="due" type="date"></label>
      <input id="note" placeholder="Optional note">
      <button id="btnUploadForm">Upload Fields</button>
    </div>
    <div id="upMsg"></div>
  </div>

  <div class="card">
    <h3>All Bills</h3>
    <div class="row">
      <button id="btnLoadBills">Load Bills</button>
      <select id="statusFilter">
        <option value="">(all)</option>
        <option value="unpaid">unpaid</option>
        <option value="paid">paid</option>
        <option value="canceled">canceled</option>
      </select>
    </div>
    <table id="billsTbl">
      <thead>
        <tr>
          <th>ID</th><th>Vendor</th><th class="right">Amount</th><th>Due</th><th>Status</th><th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div id="listMsg"></div>
  </div>

  <script>
    // ---------- helpers ----------
    const $ = sel => document.querySelector(sel);

    function getCfg() {
      const baseUrl = ($('#baseUrl').value || '').trim().replace(/\/+$/, '');
      const apiKey = ($('#apiKey').value || '').trim();
      return { baseUrl, apiKey };
    }
    function headersJSON(apiKey) {
      return { 'Content-Type': 'application/json', 'x-api-key': apiKey };
    }
    function headersForm(apiKey) {
      return { 'x-api-key': apiKey };
    }
    function saveCfg() {
      const { baseUrl, apiKey } = getCfg();
      localStorage.setItem('civic_baseUrl', baseUrl);
      localStorage.setItem('civic_apiKey', apiKey);
      $('#connMsg').textContent = `Saved. Base=${baseUrl}`;
    }
    function loadCfg() {
      const baseUrl = localStorage.getItem('civic_baseUrl') || location.origin.replace(/\/+$/, '');
      const apiKey = localStorage.getItem('civic_apiKey') || '';
      $('#baseUrl').value = baseUrl;
      $('#apiKey').value = apiKey;
      $('#connMsg').textContent = `Loaded. Base=${baseUrl}`;
    }
    function fmtAmount(x) {
      try { return Number(x).toFixed(2); } catch { return x; }
    }

    async function apiGet(path) {
      const { baseUrl, apiKey } = getCfg();
      const r = await fetch(baseUrl + path, { headers: headersForm(apiKey) });
      const text = await r.text();
      let body = null;
      try { body = JSON.parse(text); } catch { body = text; }
      return { ok: r.ok, status: r.status, body };
    }

    async function apiPostJSON(path, obj) {
      const { baseUrl, apiKey } = getCfg();
      const r = await fetch(baseUrl + path, {
        method: 'POST',
        headers: headersJSON(apiKey),
        body: JSON.stringify(obj)
      });
      const text = await r.text();
      let body = null;
      try { body = JSON.parse(text); } catch { body = text; }
      return { ok: r.ok, status: r.status, body };
    }

    async function apiPostForm(path, formData) {
      const { baseUrl, apiKey } = getCfg();
      const r = await fetch(baseUrl + path, {
        method: 'POST',
        headers: headersForm(apiKey),
        body: formData
      });
      const text = await r.text();
      let body = null;
      try { body = JSON.parse(text); } catch { body = text; }
      return { ok: r.ok, status: r.status, body };
    }

    // ---------- UI wiring ----------
    loadCfg();
    $('#saveConn').onclick = saveCfg;

    // Health
    $('#btnHealth').onclick = async () => {
      const res = await apiGet('/');
      $('#healthOut').textContent = JSON.stringify(res.body, null, 2);
    };

    // Upload file
    $('#btnUploadFile').onclick = async () => {
      const f = $('#billFile').files[0];
      if (!f) { $('#upMsg').innerHTML = '<span class="err">Choose a file</span>'; return; }
      const fd = new FormData();
      fd.append('file', f);
      const res = await apiPostForm('/upload', fd);
      if (res.ok) {
        $('#upMsg').innerHTML = `<span class="ok">Uploaded successfully.</span>`;
        await loadBills();
      } else {
        $('#upMsg').innerHTML = `<span class="err">Upload failed (${res.status}): ${escapeHtml(JSON.stringify(res.body))}</span>`;
      }
    };

    // Upload manual fields
    $('#btnUploadForm').onclick = async () => {
      const vendor = $('#vendor').value.trim();
      const amount = $('#amount').value;
      const due = $('#due').value;
      const note = $('#note').value.trim();
      if (!vendor || !amount || !due) {
        $('#upMsg').innerHTML = '<span class="err">Provide vendor, amount, and due date.</span>'; return;
      }
      const fd = new FormData();
      fd.append('vendor', vendor);
      fd.append('amount', amount);
      fd.append('due_date', due);
      if (note) fd.append('note', note);
      const res = await apiPostForm('/upload', fd);
      if (res.ok) {
        $('#upMsg').innerHTML = `<span class="ok">Uploaded successfully.</span>`;
        await loadBills();
      } else {
        $('#upMsg').innerHTML = `<span class="err">Upload failed (${res.status}): ${escapeHtml(JSON.stringify(res.body))}</span>`;
      }
    };

    // Load bills
    $('#btnLoadBills').onclick = async () => loadBills();

    $('#statusFilter').onchange = async () => loadBills();

    async function loadBills() {
      const filt = $('#statusFilter').value;
      const path = filt ? `/bills?status=${encodeURIComponent(filt)}` : '/bills';
      const res = await apiGet(path);
      const tbody = $('#billsTbl tbody');
      tbody.innerHTML = '';
      if (!res.ok) {
        $('#listMsg').innerHTML = `<span class="err">Load failed (${res.status}): ${escapeHtml(JSON.stringify(res.body))}</span>`;
        return;
      }
      const items = (res.body && res.body.items) || [];
      for (const b of items) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(b.id)}</td>
          <td>${escapeHtml(b.vendor)}</td>
          <td class="right">${fmtAmount(b.amount)}</td>
          <td>${escapeHtml(b.due_date)}</td>
          <td>${escapeHtml(b.status)}</td>
          <td>
            <button data-id="${b.id}" class="btnPaid">Mark Paid</button>
            <button data-id="${b.id}" class="btnNotify">Notify</button>
          </td>
        `;
        tbody.appendChild(tr);
      }

      // wire actions
      tbody.querySelectorAll('.btnPaid').forEach(btn => {
        btn.onclick = async () => {
          const id = btn.getAttribute('data-id');
          const res = await apiPostJSON(`/bills/${id}/mark_paid`, {});
          if (res.ok) {
            await loadBills();
          } else {
            alert(`Mark paid failed (${res.status}): ${JSON.stringify(res.body)}`);
          }
        };
      });

      tbody.querySelectorAll('.btnNotify').forEach(btn => {
        btn.onclick = async () => {
          const id = btn.getAttribute('data-id');
          const to = prompt("SMS number (E.164) or leave blank for console:", "");
          const payload = { bill_id: id, channel: to ? "sms" : "auto", to: to || undefined };
          const res = await apiPostJSON(`/notify`, payload);
          if (res.ok) {
            alert("Notification sent via " + (res.body.sent_via?.channel || 'console'));
          } else {
            alert(`Notify failed (${res.status}): ${JSON.stringify(res.body)}`);
          }
        };
      });

      $('#listMsg').textContent = items.length ? '' : 'No bills yet.';
    }

    // utility
    function escapeHtml(s) {
      return String(s).replace(/[&<>"'`=\/]/g, c => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'
      }[c]));
    }

    // auto ping & load
    (async () => {
      await document.fonts?.ready;
      $('#btnHealth').click();
      // try load bills right away (will 401 if key missing)
      loadBills();
    })();
  </script>
</body>
</html>

